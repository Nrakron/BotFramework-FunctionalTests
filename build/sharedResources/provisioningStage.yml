#
# Creates the shared resources needed for the Skills Functional Tests.
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(Build.BuildId)
trigger: none
pr: none

variables:
  BuildConfiguration: 'Debug'
  BuildPlatform: 'any cpu'
  # AzureSubscription: define in Azure
  # KeyVaultObjectId: define in Azure
  # ResourceGroupName: define in Azure

pool:
  vmImage: 'windows-2019'

stages:
- stage: Create_CosmosDB
  displayName: Create CosmosDB
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Provisioning
      steps:
      - task: AzureCLI@2
        displayName: 'Create CosmosDB Resources'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name bffnDeployment-"$(Build.BuildId)" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-cosmosdb-resources.json --parameters accountName="bffnbotstatedb" databaseName="bffnbotstatedb"'

- stage: Create_Key_Vault
  displayName: Create Key Vault
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Provisioning
      steps:
      - task: AzureCLI@2
        displayName: 'Create Resources'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name bffnDeployment-"$(Build.BuildId)" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-key-vault-resources.json --parameters keyVaultName="bffntestskeyvault" objectId="$(KeyVaultObjectId)"'

- stage: Create_Service_Plan_Windows
  displayName: Create Service Plan Windows
  jobs:
    - job: Provisioning
      steps:
      - task: AzureCLI@2
        displayName: 'Create Resources'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnDeployment" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-service-plan-windows-resources.json --parameters  newAppServicePlanName="bffnbotsappservicewin" build/templates/parameters-service-plan-windows-resources.json'

- stage: Create_Service_Plan_Linux
  displayName: Create Service Plan Linux
  jobs:
    - job: Provisioning
      steps:
      - task: AzureCLI@2
        displayName: 'Create Resources'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnDeployment" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-service-plan-linux-resources.json --parameters newAppServicePlanName="bffnbotsappservicelinux" build/templates/parameters-service-plan-linux-resources.json'

- stage: Create_App_Insights
  displayName: Create App Insights
  dependsOn: Create_Service_Plan_Windows
  jobs:
    - job: Provisioning
      steps:
      - task: AzureCLI@2
        displayName: 'Create Resources'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name bffnDeployment-"$(Build.BuildId)" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-app-insights-resources.json --parameters appInsightsName="bffnappinsights" appInsightsApplicationId="bffnbotsappservicewin"'
