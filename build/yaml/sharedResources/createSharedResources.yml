#
# Creates the shared resources needed for the Skills Functional Tests.
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(Build.BuildId)
trigger: none
pr: none

variables:
  BuildConfiguration: 'Debug'
  BuildPlatform: 'any cpu'
  # AzureSubscription: define in Azure
  # KeyVaultObjectId: define in Azure
  # ResourceGroupName: define in Azure

pool:
  vmImage: 'windows-2019'

stages:
- stage: Create_CosmosDB
  displayName: Create CosmosDB
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Deploy 'bffnbotstatedb'
      steps:
      - task: AzureCLI@2
        displayName: 'Create CosmosDB'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnbotstatedb" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-cosmosdb-resources.json --parameters accountName="bffnbotstatedb" databaseName="bffnbotstatedb"'

- stage: Create_Key_Vault
  displayName: Create Key Vault
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Deploy 'bffnbotkeyvault'
      steps:
      - task: AzureCLI@2
        displayName: 'Create Key Vault'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnbotkeyvault" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-key-vault-resources.json --parameters keyVaultName="bffnbotkeyvault" objectId="$(KeyVaultObjectId)"'

- stage: Create_Service_Plan_windows
  displayName: Create Windows Service Plan
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Deploy 'bffnbotsappservicewin'
      steps:
      - task: AzureCLI@2
        displayName: 'Create Windows Service Plan'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnbotsappservicewin" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-service-plan-windows-resources.json --parameters  newAppServicePlanName="bffnbotsappservicewin"'

- stage: Create_Service_Plan_Linux
  displayName: Create Linux Service Plan
  dependsOn: [] # Makes this run in parallel
  jobs:
    - job: Deploy 'bffnbotsappservicelinux'
      steps:
      - task: AzureCLI@2
        displayName: 'Create Linux Service Plan'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnbotsappservicelinux" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-service-plan-linux-resources.json --parameters newAppServicePlanName="bffnbotsappservicelinux"'

- stage: Create_App_Insights
  displayName: Create App Insights
  dependsOn: Create_Service_Plan_windows
  jobs:
    - job: Deploy 'bffnappinsights'
      steps:
      - task: AzureCLI@2
        displayName: 'Create App Insights'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: 'az deployment group create --name "bffnappinsights" --resource-group "$(ResourceGroupName)" --template-file build/templates/template-app-insights-resources.json --parameters appInsightsName="bffnappinsights" appInsightsApplicationId="bffnbotsappservicewin"'
